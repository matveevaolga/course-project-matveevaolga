name: P11 - DAST Security Scan

on:
  workflow_dispatch:
  push:
    branches: [p11-dast-integration]
    paths:
      - 'app/**'
      - '.github/workflows/ci-p11-dast.yml'
  pull_request:
    branches: [main]
    paths:
      - 'app/**'
      - '.github/workflows/ci-p11-dast.yml'

permissions:
  contents: read

jobs:
  dast-scan:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install "uvicorn[standard]"
        
    - name: Start FastAPI application
      run: |
        # Запускаем приложение в фоне
        uvicorn app.main:app --host 0.0.0.0 --port 8000 &
        APP_PID=$!
        echo "APP_PID=$APP_PID" >> $GITHUB_ENV
        echo "Application starting with PID: $APP_PID"
        
        # Ждем пока приложение станет доступно
        echo "Waiting for application to be ready..."
        for i in {1..30}; do
          if curl -s -f http://localhost:8000/health > /dev/null 2>&1; then
            echo " Application is ready!"
            break
          fi
          if [ $i -eq 30 ]; then
            echo "Application failed to start"
            exit 1
          fi
          echo "Attempt $i/30..."
          sleep 2
        done
        
    - name: Download ZAP
      run: |
        ZAP_VERSION="2.14.0"  # Более стабильная версия
        echo "Downloading ZAP v${ZAP_VERSION}"
        wget -q "https://github.com/zaproxy/zaproxy/releases/download/v${ZAP_VERSION}/ZAP_${ZAP_VERSION}_Linux.tar.gz"
        tar -xzf "ZAP_${ZAP_VERSION}_Linux.tar.gz"
        ls -la ZAP_${ZAP_VERSION}/
        echo "ZAP_DIR=$(pwd)/ZAP_${ZAP_VERSION}" >> $GITHUB_ENV
        
    - name: Run ZAP baseline scan
      run: |
        echo "Starting ZAP baseline scan..."
        
        # Запускаем ZAP baseline scan
        $ZAP_DIR/zap.sh -cmd \
          -silent \
          -config api.disablekey=true \
          -config scanner.attackOnStart=true \
          -quickurl http://localhost:8000 \
          -quickout "${{ github.workspace }}/zap_report.html" \
          -quickprogress
        
        echo "ZAP scan completed"
        
        # Проверяем что отчет создан
        if [ -f "zap_report.html" ]; then
          echo " Report generated successfully"
          ls -lh zap_report.html
        else
          echo " No report generated"
          exit 1
        fi
        
    - name: Generate JSON report
      run: |
        echo "Generating JSON report..."
        
        # Генерируем JSON отчет
        $ZAP_DIR/zap.sh -cmd \
          -silent \
          -config api.disablekey=true \
          -quickurl http://localhost:8000 \
          -quickout "${{ github.workspace }}/zap_report.json" \
          -quickformat json
          
        if [ -f "zap_report.json" ]; then
          echo " JSON report generated"
          # Показываем краткую статистику
          python3 << 'EOF'
import json
import sys

try:
    with open('zap_report.json') as f:
        data = json.load(f)
    
    alert_counts = {'High': 0, 'Medium': 0, 'Low': 0, 'Informational': 0}
    
    for site in data.get('site', []):
        for alert in site.get('alerts', []):
            risk = alert.get('riskcode', '0')
            if risk == '3':
                alert_counts['High'] += 1
            elif risk == '2':
                alert_counts['Medium'] += 1
            elif risk == '1':
                alert_counts['Low'] += 1
            else:
                alert_counts['Informational'] += 1
    
    print(' Scan Results Summary:')
    for level, count in alert_counts.items():
        print(f'{level}: {count}')
    
    total = sum(alert_counts.values())
    print(f'Total alerts: {total}')
    
except Exception as e:
    print(f'Error reading report: {e}')
    sys.exit(1)
EOF
        fi
        
    - name: Save reports to evidence directory
      run: |
        echo "Saving reports to EVIDENCE/P11/"
        mkdir -p EVIDENCE/P11
        
        if [ -f "zap_report.html" ]; then
          cp zap_report.html EVIDENCE/P11/zap_baseline.html
          echo " HTML report saved"
        fi
        
        if [ -f "zap_report.json" ]; then
          cp zap_report.json EVIDENCE/P11/zap_baseline.json
          echo " JSON report saved"
        fi
        
        # Создаем README с информацией
        cat > EVIDENCE/P11/README.md << 'EOF'
# P11 DAST Scan Results

## Generated Files:
- `zap_baseline.html` - Full HTML report from ZAP
- `zap_baseline.json` - Machine-readable JSON report

## How to view:
1. Open `zap_baseline.html` in any web browser
2. Use JSON report for automated analysis

## Scan Details:
- Target: http://localhost:8000
- Tool: OWASP ZAP 2.14.0
- Scan type: Baseline scan
EOF
        
        # Показываем содержимое директории
        echo " Evidence directory contents:"
        ls -la EVIDENCE/P11/
        
    - name: Upload reports as artifact
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: p11-dast-reports
        path: EVIDENCE/P11/
        retention-days: 30
        
    - name: Commit evidence to repository
      if: success()
      run: |
        echo "Committing evidence files..."
        
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        # Добавляем только новые файлы в EVIDENCE/P11
        if git status --porcelain | grep -q "EVIDENCE/P11/"; then
          git add EVIDENCE/P11/
          git commit -m "Add P11 DAST scan reports [automated]"
          git push origin HEAD:${{ github.ref_name }}
          echo " Evidence committed to repository"
        else
          echo "⚠️ No new evidence files to commit"
        fi
        
    - name: Stop application
      if: always()
      run: |
        echo "Stopping application..."
        # Останавливаем приложение если оно запущено
        if [ ! -z "$APP_PID" ]; then
          kill $APP_PID 2>/dev/null || true
        fi
        # Убиваем все процессы uvicorn на всякий случай
        pkill -f "uvicorn" 2>/dev/null || true