name: P11 - DAST Security Scan

on:
  workflow_dispatch:
  push:
    branches: [p11-dast-integration]
    paths:
      - 'app/**'
      - '.github/workflows/ci-p11-dast.yml'
  pull_request:
    branches: [main]
    paths:
      - 'app/**'
      - '.github/workflows/ci-p11-dast.yml'

permissions:
  contents: read

jobs:
  dast-scan:
    runs-on: ubuntu-latest
    timeout-minutes: 25
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install "uvicorn[standard]"
        
    - name: Start application with health check
      id: start-app
      run: |
        uvicorn app.main:app --host 0.0.0.0 --port 8000 --log-level info > app.log 2>&1 &
        UVICORN_PID=$!
        echo "UVICORN_PID=$UVICORN_PID" >> $GITHUB_ENV
        echo $UVICORN_PID > app.pid
        
        echo "Waiting for application to start..."
        
        MAX_ATTEMPTS=30
        ATTEMPT=1
        while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
          if curl -s -f http://localhost:8000/health > /dev/null 2>&1; then
            if curl -s -f http://localhost:8000/docs > /dev/null 2>&1; then
              echo "Application is fully ready! (attempt $ATTEMPT)"
              echo "app_ready=true" >> $GITHUB_OUTPUT
              break
            fi
          fi
          
          if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
            echo "Application failed to start within timeout"
            echo "Showing app logs:"
            cat app.log || true
            echo "app_ready=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          echo "Waiting for app... ($ATTEMPT/$MAX_ATTEMPTS)"
          sleep 3
          ATTEMPT=$((ATTEMPT + 1))
        done
        
    - name: Download ZAP
      if: steps.start-app.outputs.app_ready == 'true'
      run: |
        ZAP_VERSION="2.17.0"
        echo "Downloading ZAP v${ZAP_VERSION}"
        wget -q "https://github.com/zaproxy/zaproxy/releases/download/v${ZAP_VERSION}/ZAP_${ZAP_VERSION}_Linux.tar.gz"
        tar -xzf "ZAP_${ZAP_VERSION}_Linux.tar.gz"
        chmod +x "ZAP_${ZAP_VERSION}/zap.sh"
        echo "ZAP_DIR=$(pwd)/ZAP_${ZAP_VERSION}" >> $GITHUB_ENV
        
    - name: Run ZAP baseline scan
      if: steps.start-app.outputs.app_ready == 'true'
      run: |
        echo "Starting ZAP baseline scan..."
        echo "Target URL: http://localhost:8000"
        
        timeout 300 $ZAP_DIR/zap.sh -cmd \
          -silent \
          -config api.disablekey=true \
          -config scanner.attackOnStart=true \
          -config connection.timeoutInSecs=60 \
          -quickurl "http://localhost:8000" \
          -quickout "${{ github.workspace }}/zap_baseline.html" \
          -quickprogress
        
        echo "ZAP baseline scan completed"
        
        if [ -f "zap_baseline.html" ]; then
          FILESIZE=$(wc -c < "zap_baseline.html")
          echo "HTML report created: ${FILESIZE} bytes"
          if [ $FILESIZE -lt 1000 ]; then
            echo "Warning: HTML report is very small, might be empty"
          fi
        else
          echo "HTML report was not created"
          exit 1
        fi
        
    - name: Generate JSON report
      if: steps.start-app.outputs.app_ready == 'true'
      run: |
        echo "Generating JSON report..."
        
        timeout 60 $ZAP_DIR/zap.sh -cmd \
          -silent \
          -config api.disablekey=true \
          -quickurl "http://localhost:8000" \
          -quickout "${{ github.workspace }}/zap_baseline.json"
        
        if [ -f "zap_baseline.json" ]; then
          FILESIZE=$(wc -c < "zap_baseline.json")
          echo "JSON report created: ${FILESIZE} bytes"
          if [ $FILESIZE -lt 100 ]; then
            echo "Warning: JSON report is very small, might be empty"
          fi
        else
          echo "JSON report was not created"
          exit 1
        fi
 
      - name: Generate P11 Analysis Report
      if: steps.start-app.outputs.app_ready == 'true'
      run: |
        echo "Generating P11 analysis report..."
        
        mkdir -p EVIDENCE/P11
        
        if [ -f "zap_baseline.html" ]; then
          cp zap_baseline.html EVIDENCE/P11/
          echo "Copied zap_baseline.html"
        fi
        
        if [ -f "zap_baseline.json" ]; then
          cp zap_baseline.json EVIDENCE/P11/
          echo "Copied zap_baseline.json"
        fi
        
        echo "# P11 DAST Scan Analysis" > EVIDENCE/P11/P11_ANALYSIS.md
        echo "## Общая информация" >> EVIDENCE/P11/P11_ANALYSIS.md
        echo "- **Дата сканирования**: $(date '+%Y-%m-%d %H:%M:%S')" >> EVIDENCE/P11/P11_ANALYSIS.md
        echo "- **Версия ZAP**: 2.17.0" >> EVIDENCE/P11/P11_ANALYSIS.md
        echo "- **Цель**: http://localhost:8000" >> EVIDENCE/P11/P11_ANALYSIS.md
        echo "- **Статус приложения**: Запущено успешно" >> EVIDENCE/P11/P11_ANALYSIS.md
        echo "" >> EVIDENCE/P11/P11_ANALYSIS.md
        echo "## Результаты сканирования" >> EVIDENCE/P11/P11_ANALYSIS.md
        echo "" >> EVIDENCE/P11/P11_ANALYSIS.md
        
        if [ -f "zap_baseline.json" ]; then
          python_output=$(python3 << 'PYEOF'
import json, sys, os

try:
    with open('zap_baseline.json', 'r', encoding='utf-8') as f:
        data = json.load(f)
    
    alert_counts = {'High': 0, 'Medium': 0, 'Low': 0, 'Informational': 0}
    alerts_list = []
    
    for site in data.get('site', []):
        for alert in site.get('alerts', []):
            risk = alert.get('riskcode', '0')
            if risk == '3':
                alert_counts['High'] += 1
            elif risk == '2':
                alert_counts['Medium'] += 1
            elif risk == '1':
                alert_counts['Low'] += 1
            else:
                alert_counts['Informational'] += 1
            
            alerts_list.append({
                'name': alert.get('name', 'N/A'),
                'risk': risk,
                'url': alert.get('url', 'N/A'),
                'desc': alert.get('description', 'N/A')[:200]})
    
    output_lines = []
    output_lines.append("### Статистика алертов")
    output_lines.append(f"- **High**: {alert_counts['High']}")
    output_lines.append(f"- **Medium**: {alert_counts['Medium']}")
    output_lines.append(f"- **Low**: {alert_counts['Low']}")
    output_lines.append(f"- **Informational**: {alert_counts['Informational']}")
    output_lines.append(f"\n**Всего алертов**: {sum(alert_counts.values())}")
    
    if alerts_list:
        output_lines.append("\n### Примеры для анализа")
        for i, alert in enumerate(alerts_list[:3], 1):
            risk_map = {'3': 'High', '2': 'Medium', '1': 'Low', '0': 'Informational'}
            risk_level = risk_map.get(alert['risk'], 'Informational')
            output_lines.append(f"{i}. **{alert['name']}** ({risk_level})")
            output_lines.append(f"   - URL: {alert['url']}")
            output_lines.append(f"   - Описание: {alert['desc']}...")
            output_lines.append("")
    
    print("\n".join(output_lines))

except Exception as e:
    error_msg = f"Ошибка при анализе отчёта: {str(e)}\n\n**Примечание**: Файл отчёта существует, но не может быть проанализирован.\nПроверьте содержимое zap_baseline.json вручную."
    print(error_msg)
PYEOF
          )
          
          echo "$python_output" >> EVIDENCE/P11/P11_ANALYSIS.md
        else
          echo "**Внимание**: Основной отчёт ZAP (zap_baseline.json) не был создан." >> EVIDENCE/P11/P11_ANALYSIS.md
          echo "Проверьте логи выполнения предыдущих шагов." >> EVIDENCE/P11/P11_ANALYSIS.md
        fi
        
        echo "" >> EVIDENCE/P11/P11_ANALYSIS.md
        echo "## Рекомендации" >> EVIDENCE/P11/P11_ANALYSIS.md
        echo "" >> EVIDENCE/P11/P11_ANALYSIS.md
        echo "1. **High/Medium риски** требуют немедленного исправления" >> EVIDENCE/P11/P11_ANALYSIS.md
        echo "2. **Low риски** рекомендуется исправить в течение спринта" >> EVIDENCE/P11/P11_ANALYSIS.md
        echo "3. **Informational** - могут быть приняты с обоснованием" >> EVIDENCE/P11/P11_ANALYSIS.md
        echo "" >> EVIDENCE/P11/P11_ANALYSIS.md
        echo "## Следующие шаги" >> EVIDENCE/P11/P11_ANALYSIS.md
        echo "" >> EVIDENCE/P11/P11_ANALYSIS.md
        echo "1. Откройте zap_baseline.html для детального просмотра" >> EVIDENCE/P11/P11_ANALYSIS.md
        echo "2. Проанализируйте критические алерты" >> EVIDENCE/P11/P11_ANALYSIS.md
        echo "3. Внесите исправления в код приложения" >> EVIDENCE/P11/P11_ANALYSIS.md
        echo "4. Повторите сканирование для проверки" >> EVIDENCE/P11/P11_ANALYSIS.md
        echo "" >> EVIDENCE/P11/P11_ANALYSIS.md
        echo "---" >> EVIDENCE/P11/P11_ANALYSIS.md
        echo "*Этот файл создан автоматически. Дополните его результатами ручного анализа.*" >> EVIDENCE/P11/P11_ANALYSIS.md
        
        echo "P11_ANALYSIS.md created"
        
    - name: Verify and list files
      run: |
        echo "=== Verification of generated files ==="
        if [ -d "EVIDENCE/P11" ]; then
          echo "Contents of EVIDENCE/P11/:"
          ls -la EVIDENCE/P11/
          
          echo -e "\nFile sizes:"
          for file in EVIDENCE/P11/*; do
            if [ -f "$file" ]; then
              size=$(wc -c < "$file")
              echo "$(basename "$file"): $size bytes"
            fi
          done
        else
          echo "EVIDENCE/P11 directory not found!"
        fi
        
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: zap-reports
        path: EVIDENCE/P11/
        retention-days: 30
        
    - name: Stop application
      if: always()
      run: |
        echo "Stopping application..."
        if [ -f "app.pid" ]; then
          PID=$(cat app.pid)
          echo "Stopping process $PID"
          kill $PID 2>/dev/null || true
          sleep 2
          if ps -p $PID > /dev/null 2>&1; then
            echo "Process still running, forcing kill..."
            kill -9 $PID 2>/dev/null || true
          fi
          rm -f app.pid
        fi
        rm -f app.log zap_baseline.html zap_baseline.json 2>/dev/null || true
        echo "Cleanup completed"