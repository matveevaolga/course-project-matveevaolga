name: Security - SBOM & SCA Scan

on:
  workflow_dispatch:
  push:
    branches: [ main, p07-containerization, p08-ci-cd, p09-security-sbom ]
    paths:
      - '**/*.py'
      - 'requirements*.txt'
      - 'pyproject.toml'
      - '.github/workflows/security.yml'
  pull_request:
    branches: [ main, p07-containerization ]

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  sbom_sca:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure evidence dirs
        run: mkdir -p EVIDENCE/P09

      - name: Generate SBOM with Syft
        run: |
          docker run --rm \
            -v "$(pwd):/work" \
            -w /work \
            anchore/syft:v1.11.0 \
            packages dir:. \
            -o cyclonedx-json \
            > EVIDENCE/P09/sbom-$(date +%Y%m%d-%H%M%S)-${{ github.sha }}.json

      - name: Create latest SBOM symlink
        run: |
          latest=$(ls -t EVIDENCE/P09/sbom-*.json | head -1)
          ln -sf $(basename $latest) EVIDENCE/P09/sbom-latest.json

      - name: SCA Scan with Grype
        run: |
          docker run --rm \
            -v "$(pwd):/work" \
            -w /work \
            anchore/grype:v0.80.0 \
            sbom:/work/EVIDENCE/P09/sbom-latest.json \
            -o json \
            > EVIDENCE/P09/grype-report-$(date +%Y%m%d-%H%M%S).json

      - name: Python SCA with pip-audit
        run: |
          pip install pip-audit
          pip-audit -r requirements.txt -r requirements-dev.txt \
            --format json \
            > EVIDENCE/P09/pip-audit-report-$(date +%Y%m%d-%H%M%S).json

      - name: Generate combined SCA summary
        run: |
          echo "# SCA Vulnerability Summary" > EVIDENCE/P09/sca_summary.md
          echo "Generated: $(date)" >> EVIDENCE/P09/sca_summary.md
          echo "Commit: [${{ github.sha }}](https://github.com/${{ github.repository }}/commit/${{ github.sha }})" >> EVIDENCE/P09/sca_summary.md
          echo "" >> EVIDENCE/P09/sca_summary.md

          grype_report=$(ls -t EVIDENCE/P09/grype-report-*.json | head -1)
          pip_report=$(ls -t EVIDENCE/P09/pip-audit-report-*.json | head -1)

          echo "## Tools Used" >> EVIDENCE/P09/sca_summary.md
          echo "- Syft v1.11.0 (SBOM generation)" >> EVIDENCE/P09/sca_summary.md
          echo "- Grype v0.80.0 (general SCA)" >> EVIDENCE/P09/sca_summary.md
          echo "- pip-audit (Python-specific SCA)" >> EVIDENCE/P09/sca_summary.md
          echo "" >> EVIDENCE/P09/sca_summary.md

          echo "## Grype Results" >> EVIDENCE/P09/sca_summary.md
          if [ -f "$grype_report" ]; then
            echo "### Severity Distribution" >> EVIDENCE/P09/sca_summary.md
            jq -r '
              [.matches[].vulnerability.severity]
              | group_by(.)
              | map({severity: .[0], count: length})
              | sort_by(.severity)
            ' "$grype_report" >> EVIDENCE/P09/sca_summary.md || echo "No vulnerabilities found" >> EVIDENCE/P09/sca_summary.md
          fi

          echo "" >> EVIDENCE/P09/sca_summary.md
          echo "## pip-audit Results" >> EVIDENCE/P09/sca_summary.md
          if [ -f "$pip_report" ]; then
            pip-audit -r requirements.txt -r requirements-dev.txt \
              --format markdown \
              >> EVIDENCE/P09/sca_summary.md || echo "No Python vulnerabilities found" >> EVIDENCE/P09/sca_summary.md
          fi

          echo "" >> EVIDENCE/P09/sca_summary.md
          echo "## Action Plan" >> EVIDENCE/P09/sca_summary.md
          echo "1. Review Critical/High vulnerabilities immediately" >> EVIDENCE/P09/sca_summary.md
          echo "2. Address Medium vulnerabilities in next sprint" >> EVIDENCE/P09/sca_summary.md
          echo "3. Monitor Low vulnerabilities regularly" >> EVIDENCE/P09/sca_summary.md
          echo "4. Create waivers for justified exceptions" >> EVIDENCE/P09/sca_summary.md

      - name: Policy check
        run: |
          echo "## Policy Compliance Check" > EVIDENCE/P09/policy_check.md
          echo "Generated: $(date)" >> EVIDENCE/P09/policy_check.md

          if [ -f "policy/waivers.yml" ]; then
            waiver_count=$(yq eval '.waivers | length' policy/waivers.yml 2>/dev/null || echo "0")
            echo "Waivers count: $waiver_count" >> EVIDENCE/P09/policy_check.md
          else
            echo " policy/waivers.yml not found" >> EVIDENCE/P09/policy_check.md
          fi

      - name: Upload security evidence
        uses: actions/upload-artifact@v4
        with:
          name: P09_SECURITY_EVIDENCE
          path: EVIDENCE/P09/
          retention-days: 90
