# ADR-001: Внедрение кэширования для эндпоинта статистики

## Status
**Accepted** (2025-11-03)

## Context
Система Feature Votes испытывает проблемы производительности при частых запросах к эндпоинту `/stats`:
- **Высокая нагрузка:** Каждый запрос пересчитывает статистику с нуля
- **Низкая производительность:** При >=100 фичах вычисления занимают значительное время
- **Избыточные вычисления:** Статистика не требует мгновенного обновления

**Требования из P03 NFR:**
- P1: Время отклика API <= 200 мс
- P2: Обработка >= 1000 запросов в час

## Decision
Мы решили внедрить **in-memory кэширование с TTL 30 секунд** для эндпоинта `/stats`.

**Архитектурные компоненты:**
- Простой in-memory кэш на основе словаря Python
- TTL (Time-To-Live) 30 секунд для баланса актуальности и производительности
- Автоматическая инвалидация кэша при изменении данных (новые голоса/фичи)

**Стек технологий:**
- Python 3.12 и стандартная библиотека
- `datetime` для управления временем жизни
- Декоратор для прозрачного кэширования

## Alternatives Considered

### Альтернатива 1: Без кэширования (текущее решение)
**Плюсы:**
- Всегда актуальные данные
- Простая реализация
- Нет проблем с консистентностью

**Минусы:**
- Высокая вычислительная нагрузка
- Медленные ответы при большом количестве данных
- Не масштабируется

### Альтернатива 2: Redis/Memcached
**Плюсы:**
- Распределенное кэширование
- Продвинутые функции (кластеризация, persistence)
- Стандартное решение для production

**Минусы:**
- Избыточно для текущего масштаба
- Дополнительная зависимость и сложность
- Overhead на сетевые запросы

### Альтернатива 3: Database-level кэширование
**Плюсы:**
- Консистентность с данными
- Использование существующей инфраструктуры
- Хорошая интеграция с ORM

**Минусы:**
- Требует миграции на БД
- Меньшая производительность чем in-memory
- Сложность реализации

## Consequences

### Положительные:
- Улучшение производительности - снижение времени ответа на 70-80%
- Снижение нагрузки - уменьшение вычислений при частых запросах
- Простота реализации - минимальные изменения в коде
- Обратная совместимость - API не меняется

### Отрискательные:
- Задержка обновления - данные могут быть до 30 секунд устаревшими
- Потребление памяти - дополнительные 1-2KB на кэш
- Консистентность - возможны расхождения при параллельных запросах

### Security Impact
**Риски:**
- Утечка памяти при неправильной реализации (mitigated by TTL)
- Кэш-poisoning атаки (mitigated by input validation)

**Связь с Threat Modeling (P04):**
- Улучшает защиту от **Denial of Service** - снижает нагрузку на сервер
- Не влияет на **Data Integrity** - кэш только для чтения

**Связь с NFR (P03):**
- Соответствует P1: "Время отклика API <= 200 мс"
- Соответствует P2: "Обработка >= 1000 запросов в час"
- Улучшает SC1: "Масштабируемость системы"

## Rollout Plan

### Definition of Done (DoD):
- Класс SimpleCache с TTL функциональностью
- Интеграция кэширования в эндпоинт `/stats`
- Тесты для кэширования (hit/miss, TTL, инвалидация)
- Мониторинг эффективности кэширования
- Документация по использованию кэша

### План внедрения:
1. **Этап 1:** Реализация кэширования (1 день)
2. **Этап 2:** Тестирование (1 день)
3. **Этап 3:** Деплой в production (после аппрува и мержа PR)

### Feature Flags:
- `CACHE_ENABLED=true|false` - переключение кэширования
- `CACHE_TTL_SECONDS=30` - настройка времени жизни

## References
- [Python datetime documentation](https://docs.python.org/3/library/datetime.html)
- [P03 NFR Requirements](https://github.com/matveevaolga/course-project-matveevaolga/blob/p03-nfr-requirements/docs/NFR.md)
- [P04 Threat Modeling](https://github.com/matveevaolga/course-project-matveevaolga/blob/p04-threat-modeling/docs/STRIDE.md)

## Commits
- Реализация кеширования: [коммит f8282c6](https://github.com/matveevaolga/course-project-matveevaolga/commit/f8282c6a17892fa90345fff21da6a66785bcc280)
- Тесты кеширования: [коммит f8282c6](https://github.com/matveevaolga/course-project-matveevaolga/commit/f8282c6a17892fa90345fff21da6a66785bcc280)

## Related ADRs
- [ADR-002: In-memory storage](https://github.com/matveevaolga/course-project-matveevaolga/blob/p05-caching-adr/app/docs/ADR-002-in-memory-storage.md)
- [ADR-003: Stateless architecture](https://github.com/matveevaolga/course-project-matveevaolga/blob/p05-caching-adr/app/docs/ADR-003-stateless-architecture.md)
