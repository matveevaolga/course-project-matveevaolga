# ADR-001: Внедрение кэширования для эндпоинта статистики

## Status
**Proposed** (2025-11-03)

## Context
Система Feature Votes испытывает проблемы производительности при частых запросах к эндпоинту `/stats`:
- **Высокая нагрузка:** Каждый запрос пересчитывает статистику с нуля
- **Низкая производительность:** При 100+ фичах вычисления занимают значительное время
- **Избыточные вычисления:** Статистика не требует мгновенного обновления

**Требования из P03 NFR:**
- P1: Время отклика API ≤ 200 мс
- P2: Обработка ≥ 1000 запросов в час

## Decision
Мы решили внедрить **in-memory кэширование с TTL 30 секунд** для эндпоинта `/stats`.

**Архитектурные компоненты:**
- Простой in-memory кэш на основе словаря Python
- TTL (Time-To-Live) 30 секунд для баланса актуальности и производительности
- Автоматическая инвалидация кэша при изменении данных (новые голоса/фичи)

**Стек технологий:**
- Python 3.11 + стандартная библиотека
- `datetime` для управления временем жизни
- Декоратор для прозрачного кэширования

## Alternatives Considered

### Альтернатива 1: Без кэширования (текущее решение)
**Плюсы:**
- Всегда актуальные данные
- Простая реализация
- Нет проблем с консистентностью

**Минусы:**
- Высокая вычислительная нагрузка
- Медленные ответы при большом количестве данных
- Не масштабируется

### Альтернатива 2: Redis/Memcached
**Плюсы:**
- Распределенное кэширование
- Продвинутые функции (кластеризация, persistence)
- Стандартное решение для production

**Минусы:**
- Избыточно для текущего масштаба
- Дополнительная зависимость и сложность
- Overhead на сетевые запросы

### Альтернатива 3: Database-level кэширование
**Плюсы:**
- Консистентность с данными
- Использование существующей инфраструктуры
- Хорошая интеграция с ORM

**Минусы:**
- Требует миграции на БД
- Меньшая производительность чем in-memory
- Сложность реализации

## Consequences

### Положительные:
- Улучшение производительности - снижение времени ответа на 70-80%
- Снижение нагрузки - уменьшение вычислений при частых запросах
- Простота реализации - минимальные изменения в коде
- Обратная совместимость - API не меняется

### Отрискательные:
- Задержка обновления - данные могут быть до 30 секунд устаревшими
- Потребление памяти - дополнительные ~1-2KB на кэш
- Консистентность - возможны расхождения при параллельных запросах

### Security Impact
**Риски:**
- Утечка памяти при неправильной реализации (mitigated by TTL)
- Кэш-poisoning атаки (mitigated by input validation)

**Связь с Threat Modeling (P04):**
- Улучшает защиту от **Denial of Service** - снижает нагрузку на сервер
- Не влияет на **Data Integrity** - кэш только для чтения

**Связь с NFR (P03):**
- Соответствует P1: "Время отклика API ≤ 200 мс"
- Соответствует P2: "Обработка ≥ 1000 запросов в час"
- Улучшает SC1: "Масштабируемость системы"

## Rollout Plan

### Definition of Done (DoD):
- Класс SimpleCache с TTL функциональностью
- Интеграция кэширования в эндпоинт `/stats`
- Тесты для кэширования (hit/miss, TTL, инвалидация)
- Мониторинг эффективности кэширования
- Документация по использованию кэша

### План внедрения:
1. **Фаза 1:** Разработка и тестирование (1 день)
2. **Фаза 2:** Мониторинг в development (1 день)
3. **Фаза 3:** Деплой в production (после проверки)

### Feature Flags:
- `CACHE_ENABLED=true|false` - переключение кэширования
- `CACHE_TTL_SECONDS=30` - настройка времени жизни

## References
- [P03 NFR Requirements](../NFR.md)
- [P04 Threat Modeling](../STRIDE.md)
- [Python datetime documentation](https://docs.python.org/3/library/datetime.html)

## Commits
- Реализация: [коммит abc123](https://github.com/username/repo/commit/abc123)
- Тесты: [коммит def456](https://github.com/username/repo/commit/def456)
